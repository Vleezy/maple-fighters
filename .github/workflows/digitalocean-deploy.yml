name: DigitalOcean Deploy

on:
  workflow_dispatch:

env:
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml
  DOCKER_COMPOSE_URL: https://raw.githubusercontent.com/codingben/maple-fighters/develop/docker-compose.prod.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DIGITALOCEAN_HOST }}
          username: ${{ secrets.DIGITALOCEAN_USERNAME }}
          key: ${{ secrets.DIGITALOCEAN_KEY }}
          port: ${{ secrets.DIGITALOCEAN_PORT }}
          script: |
            rm ${{ env.DOCKER_COMPOSE_FILE }}
            curl -s ${{ env.DOCKER_COMPOSE_URL }} -o ${{ env.DOCKER_COMPOSE_FILE }}

            export AUTH_DB_USER=${{ secrets.AUTH_DB_USER }}
            export AUTH_DB_PASSWORD=${{ secrets.AUTH_DB_PASSWORD }}
            export AUTH_DB_NAME=${{ secrets.AUTH_DB_NAME }}

            export CHARACTER_DB_USER=${{ secrets.CHARACTER_DB_USER }}
            export CHARACTER_DB_PASSWORD=${{ secrets.CHARACTER_DB_PASSWORD }}
            export CHARACTER_DB_NAME=${{ secrets.CHARACTER_DB_NAME }}
            
            docker-compose -f ${{ env.DOCKER_COMPOSE_FILE }} pull
            docker-compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d
            docker system prune -af
